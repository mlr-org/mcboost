<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCBoost - Health Survey Example â€¢ mcboost</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MCBoost - Health Survey Example">
<meta property="og:description" content="mcboost">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcboost</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mcboost_basics_extensions.html">MCBoost - Basics and Extensions</a>
    </li>
    <li>
      <a href="../articles/mcboost_example.html">MCBoost - Health Survey Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlr-org/mcboost/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mcboost_example_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MCBoost - Health Survey Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mcboost/blob/HEAD/vignettes/mcboost_example.Rmd" class="external-link"><code>vignettes/mcboost_example.Rmd</code></a></small>
      <div class="hidden name"><code>mcboost_example.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PracTools</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/neuralnet" class="external-link">neuralnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://renkun-ken.github.io/formattable/" class="external-link">formattable</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com" class="external-link">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/mcboost" class="external-link">mcboost</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-and-setup">Data and Setup<a class="anchor" aria-label="anchor" href="#data-and-setup"></a>
</h2>
<p>This vignette presents two typical use cases of MCBoost with data from a health survey. The goal is to post-process two initial prediction models for multi-accuracy using different flavors of MCBoost, and to eventually compare the naive and post-processed predictors overall and for subpopulations. The first scenario starts with a neural net and, as an example, evaluates the initial and post-processed predictors with a focus on subgroup accuracy after running MCBoost. The second scenario uses a random forest and evaluates the initial and post-processed predictors with respect to subgroup calibration.</p>
<p>We use data derived from the National Health Interview Survey (NHIS 2003), which includes demographic and health-related variables for 21,588 individuals. This data can directly be included from the <code>PracTools</code> package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">nhis.large</span><span class="op">)</span></span></code></pre></div>
<p>We can obtain more information using:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">nhis.large</span></span></code></pre></div>
<p>In the following, our outcome of interest is whether an individual is covered by any type of health insurance (<code>notcov</code>, 1 = not covered, 0 = covered). We additionally prepare two sets of variables:</p>
<ul>
<li>Predictor variables (age, parents in household, education, income, employment status, physical or other limitations)</li>
<li>Subpopulation variables (sex, hispanic ethnicity, race)</li>
</ul>
<p>The second set of variables will not be used for training the initial prediction models, but will be our focus when it comes to evaluating prediction performance for subgroups.</p>
<p>Before we training an initial model, we preprocess the data:</p>
<ul>
<li>We encode categorical features as <code>factor</code>.</li>
<li>We explicitly assign <code>NA</code>s in categorical features to a dedicated factor level</li>
<li>We drop <code>NA</code>s in the outcome variable <code>notcov</code>
</li>
<li>We encode <code>notcov</code> as a factor variable instead of a dummy variable (1 = <code>notcov</code>, 0 = <code>cov</code>)</li>
<li>We create a new feature <code>inv_wt</code> as the inverse of survey weights <code>svwyt</code>
</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">categorical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age.grp"</span>, <span class="st">"parents"</span>, <span class="st">"educ"</span>, <span class="st">"inc.grp"</span>, <span class="st">"doing.lw"</span>,</span>
<span>  <span class="st">"limited"</span>, <span class="st">"sex"</span>, <span class="st">"hisp"</span>, <span class="st">"race"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nhis</span> <span class="op">&lt;-</span> <span class="va">nhis.large</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="va">categorical</span>, <span class="va">as.factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="va">categorical</span>, <span class="va">fct_explicit_na</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">notcov</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">categorical</span><span class="op">)</span>, <span class="va">notcov</span>, <span class="va">svywt</span>, <span class="va">ID</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nhis</span><span class="op">$</span><span class="va">notcov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">nhis</span><span class="op">$</span><span class="va">notcov</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"notcov"</span>, <span class="st">"cov"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nhis_enc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">notcov</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">nhis</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">nhis_enc</span><span class="op">$</span><span class="va">notcov</span> <span class="op">&lt;-</span> <span class="va">nhis</span><span class="op">$</span><span class="va">notcov</span></span>
<span><span class="va">nhis_enc</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="va">nhis</span><span class="op">$</span><span class="va">sex</span></span>
<span><span class="va">nhis_enc</span><span class="op">$</span><span class="va">hisp</span> <span class="op">&lt;-</span> <span class="va">nhis</span><span class="op">$</span><span class="va">hisp</span></span>
<span><span class="va">nhis_enc</span><span class="op">$</span><span class="va">race</span> <span class="op">&lt;-</span> <span class="va">nhis</span><span class="op">$</span><span class="va">race</span></span>
<span><span class="va">nhis_enc</span><span class="op">$</span><span class="va">inv_wt</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">nhis</span><span class="op">$</span><span class="va">svywt</span><span class="op">)</span></span></code></pre></div>
<p>The pre-processed NHIS data will be split into three datasets:</p>
<ul>
<li>A training set <code>train</code> for training the initial prediction models (55 % of data)</li>
<li>An auditing set <code>post</code> for post-processing the initial models with MCBoost (20 %)</li>
<li>A test set <code>test</code>for model evaluation (25 %)</li>
</ul>
<p>To increase the difficulty of the prediction task, we sample from the NHIS data such that the prevalence of demographic subgroups in the test data differs from their prevalence in the training and auditing data. This is achieved by employing weighted sampling from NHIS (variable <code>inv_wt</code> from above).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2953</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">nhis_enc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fl">0.25</span>, weight_by <span class="op">=</span> <span class="va">inv_wt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nontest_g</span> <span class="op">&lt;-</span> <span class="va">nhis_enc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span><span class="va">test</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_g</span> <span class="op">&lt;-</span> <span class="va">nontest_g</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></span>
<span></span>
<span><span class="va">post</span> <span class="op">&lt;-</span> <span class="va">nontest_g</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span><span class="va">train_g</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">svywt</span>, <span class="op">-</span><span class="va">inv_wt</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sex</span><span class="op">:</span><span class="va">race</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">train_g</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">svywt</span>, <span class="op">-</span><span class="va">inv_wt</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sex</span><span class="op">:</span><span class="va">race</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sex2</span><span class="op">:</span><span class="va">race3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>As a result, non-hispanic white individuals (<code>hisp2</code>) are overrepresented and hispanic individuals are underrepresented in both the training and auditing set, compared to their prevalence in the test set.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_g</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex2</span><span class="op">:</span><span class="va">race3</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="co">#&gt;        sex2     hisp2     hisp3     hisp4     race2      race3</span></span>
<span><span class="co">#&gt; 1 0.5118551 0.6252296 0.1416764 0.0399065 0.1477709 0.04449825</span></span>
<span><span class="co"># hispanic individuals</span></span>
<span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">train_g</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">hisp2</span><span class="op">:</span><span class="va">hisp4</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1931875</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex2</span><span class="op">:</span><span class="va">race3</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="co">#&gt;        sex2     hisp2     hisp3      hisp4     race2      race3</span></span>
<span><span class="co">#&gt; 1 0.5224142 0.6278487 0.1402454 0.03806662 0.1460055 0.04282494</span></span>
<span><span class="co"># hispanic individuals</span></span>
<span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">post</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">hisp2</span><span class="op">:</span><span class="va">hisp4</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1938392</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex2</span><span class="op">:</span><span class="va">race3</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="co">#&gt;       sex2     hisp2     hisp3      hisp4     race2      race3</span></span>
<span><span class="co">#&gt; 1 0.520759 0.4711629 0.1410859 0.03700921 0.1487883 0.04414804</span></span>
<span><span class="co"># hispanic individuals</span></span>
<span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">hisp2</span><span class="op">:</span><span class="va">hisp4</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3507421</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="scenario-1-improve-subgroup-accuracy">Scenario 1: Improve Subgroup Accuracy<a class="anchor" aria-label="anchor" href="#scenario-1-improve-subgroup-accuracy"></a>
</h2>
<p>We train an initial model for predicting healthcare coverage with the training set. Here, we use a neural network with one hidden layer, rather naively with little tweaking.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html" class="external-link">neuralnet</a></span><span class="op">(</span><span class="va">notcov</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  hidden <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  linear.output <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  err.fct <span class="op">=</span> <span class="st">'ce'</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lifesign <span class="op">=</span> <span class="st">'full'</span>,</span>
<span>  data <span class="op">=</span> <span class="va">train</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="mcboost-auditing">MCBoost Auditing<a class="anchor" aria-label="anchor" href="#mcboost-auditing"></a>
</h3>
<p>We prepare a function that allows us to pass the predictions of the model to MCBoost for post-processing.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">init_nnet</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">nnet</span>, <span class="va">data</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To showcase different use cases of MCBoost, we prepare two post-processing data sets based on the auditing set. The first set includes only the predictor variables that were used by the initial models, whereas the second set will allow post-processing based on our demographic subgroups of interest (sex, hispanic ethnicity, race).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">post</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">notcov</span>, <span class="va">sex2</span><span class="op">:</span><span class="va">race3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">post</span>, <span class="op">-</span><span class="va">notcov</span><span class="op">)</span></span>
<span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/one_hot.html">one_hot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">notcov</span><span class="op">)</span></span></code></pre></div>
<p>We initialize two custom auditors for MCBoost: Ridge regression with a small penalty on model complexity, and a <code>SubpopAuditorFitter</code> with a fixed set of subpopulations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ridge</span> <span class="op">=</span> <span class="va"><a href="../reference/LearnerAuditorFitter.html">LearnerAuditorFitter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.glmnet"</span>, alpha <span class="op">=</span> <span class="fl">0</span>, lambda <span class="op">=</span> <span class="fl">2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">post</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pops</span> <span class="op">=</span> <span class="va"><a href="../reference/SubpopAuditorFitter.html">SubpopAuditorFitter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"sex2"</span>, <span class="st">"hisp2"</span>, <span class="st">"hisp3"</span>, <span class="st">"hisp4"</span>, <span class="st">"race2"</span>, <span class="st">"race3"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The ridge regression will only be given access to the initial predictor variables when post-processing the neural net predictions with the auditing data. In contrast, we guide the subpop-fitter to audit the initial predictions explicitly on the outlined subpopulations (sex, hispanic ethnicity, race). In summary, we have:</p>
<ul>
<li>
<code>nnet</code>: Initial neural net</li>
<li>
<code>nnet_mc_ridge</code>: Neural net, post-processed with ridge regression and the initial set of predictor variables</li>
<li>
<code>nnet_mc_subpop</code>: Neural net, post-processed with a fixed set of subpopulations</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nnet_mc_ridge</span> <span class="op">=</span> <span class="va"><a href="../reference/MCBoost.html">MCBoost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>init_predictor <span class="op">=</span> <span class="va">init_nnet</span>,</span>
<span>                            auditor_fitter <span class="op">=</span> <span class="va">ridge</span>,</span>
<span>                            multiplicative <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            partition <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            max_iter <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">nnet_mc_ridge</span><span class="op">$</span><span class="fu">multicalibrate</span><span class="op">(</span><span class="va">d1</span>, <span class="va">l</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nnet_mc_subpop</span> <span class="op">=</span> <span class="va"><a href="../reference/MCBoost.html">MCBoost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>init_predictor <span class="op">=</span> <span class="va">init_nnet</span>,</span>
<span>                             auditor_fitter <span class="op">=</span> <span class="va">pops</span>,</span>
<span>                             partition <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             max_iter <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">nnet_mc_subpop</span><span class="op">$</span><span class="fu">multicalibrate</span><span class="op">(</span><span class="va">d2</span>, <span class="va">l</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-evaluation">Model Evaluation<a class="anchor" aria-label="anchor" href="#model-evaluation"></a>
</h3>
<p>Next, we use the initial and post-processed models to predict the outcome in the test data. We compute predicted probabilities and class predictions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span><span class="op">$</span><span class="va">nnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">nnet</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">nnet_mc_ridge</span> <span class="op">&lt;-</span> <span class="va">nnet_mc_ridge</span><span class="op">$</span><span class="fu">predict_probs</span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">nnet_mc_subpop</span> <span class="op">&lt;-</span> <span class="va">nnet_mc_subpop</span><span class="op">$</span><span class="fu">predict_probs</span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">c_nnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">nnet</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">c_nnet_mc_ridge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">nnet_mc_ridge</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">c_nnet_mc_subpop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">nnet_mc_subpop</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/one_hot.html">one_hot</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">notcov</span><span class="op">)</span></span></code></pre></div>
<p>Here we compare the overall accuracy of the initial and post-processed models. Overall, we observe little differences in performance.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">c_nnet</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8185234</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">c_nnet_mc_ridge</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8237836</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">c_nnet_mc_subpop</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8226564</span></span></code></pre></div>
<p>However, we might be concerned with model performance for smaller subpopulations. In the following, we focus on subgroups defined by 2-way conjunctions of sex, hispanic ethnicity, and race.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sex</span>, <span class="va">hisp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex_hisp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sex</span>, <span class="va">race</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex_race <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">hisp</span>, <span class="va">race</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>hisp_race <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grouping_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"hisp"</span>, <span class="st">"race"</span>, <span class="st">"sex_hisp"</span>, <span class="st">"sex_race"</span>, <span class="st">"hisp_race"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">grouping_vars</span>, <span class="va">group_by_at</span>, .tbl <span class="op">=</span> <span class="va">test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">summarise</span>,</span>
<span>      <span class="st">'accuracy_nnet'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">c_nnet</span> <span class="op">==</span> <span class="va">label</span><span class="op">)</span>,</span>
<span>      <span class="st">'accuracy_nnet_mc_ridge'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">c_nnet_mc_ridge</span> <span class="op">==</span> <span class="va">label</span><span class="op">)</span>,</span>
<span>      <span class="st">'accuracy_nnet_mc_subpop'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">c_nnet_mc_subpop</span> <span class="op">==</span> <span class="va">label</span><span class="op">)</span>,</span>
<span>      <span class="st">'size'</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We evaluate classification accuracy on these subpopulations, and order the results according to the size of the selected subgroups (<code>size</code>). Subgroup accuracy varies between methods, with MCBoost-Ridge (<code>nnet_mc_ridge</code>) and MCBoost-Subpop (<code>nnet_mc_subpop</code>) stabilizing subgroup performance when compared to the initial model, respectively.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eval</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">accuracy_nnet</span><span class="op">:</span><span class="va">accuracy_nnet_mc_subpop</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/formattable.html" class="external-link">formattable</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">eval</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/area.html" class="external-link">area</a></span><span class="op">(</span><span class="va">row</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/color_tile.html" class="external-link">color_tile</a></span><span class="op">(</span><span class="st">"transparent"</span>, <span class="st">"lightgreen"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table table table-condensed">
<thead><tr>
<th style="text-align:right;">
size
</th>
<th style="text-align:right;">
accuracy_nnet
</th>
<th style="text-align:right;">
accuracy_nnet_mc_ridge
</th>
<th style="text-align:right;">
accuracy_nnet_mc_subpop
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
4296
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.816</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.820</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c7f6c7">0.818</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2772
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.814</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #a2f0a2">0.819</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.820</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2551
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.824</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.829</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #d2f8d2">0.826</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2508
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.893</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c7f6c7">0.896</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.899</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2508
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.893</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c7f6c7">0.896</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.899</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2206
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.813</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.816</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #b5f3b5">0.815</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2090
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.820</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.824</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c7f6c7">0.822</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1867
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #dffadf">0.715</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.720</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.713</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1788
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c7f6c7">0.709</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.713</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.705</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1284
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.898</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.898</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.905</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1224
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.888</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.894</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #a2f0a2">0.893</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
967
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #d6f8d6">0.702</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.709</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.698</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
900
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.729</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.732</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.729</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
792
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.837</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #9ef09e">0.850</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.852</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
751
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.836</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #a7f1a7">0.847</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.850</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
751
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.836</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #a7f1a7">0.847</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.850</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
440
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.823</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #bdf4bd">0.839</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.850</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
416
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.822</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #b9f4b9">0.837</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.846</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
352
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.855</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.864</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.855</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
335
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.854</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.860</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.854</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
235
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.796</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.809</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #dcf9dc">0.800</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.782</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.797</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #daf9da">0.787</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.782</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.797</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #daf9da">0.787</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
126
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.794</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.802</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.802</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
109
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.798</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.817</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.798</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
105
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.781</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.790</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.790</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
92
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.783</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.804</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.783</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
41
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.854</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.902</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.902</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
38
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.868</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.868</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.868</span>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="scenario-2-improve-subgroup-calibration">Scenario 2: Improve Subgroup Calibration<a class="anchor" aria-label="anchor" href="#scenario-2-improve-subgroup-calibration"></a>
</h2>
<p>In this scenario, we use a random forest with the default settings of the ranger package as the initial predictor.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="va">notcov</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, probability <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="mcboost-auditing-1">MCBoost Auditing<a class="anchor" aria-label="anchor" href="#mcboost-auditing-1"></a>
</h3>
<p>We again prepare a function to pass the predictions to MCBoost for post-processing.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">init_rf</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rf</span>, <span class="va">data</span><span class="op">)</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We use two custom auditors for MCBoost, i.e., ridge and lasso regression with different penalties on model complexity.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ridge</span> <span class="op">=</span> <span class="va"><a href="../reference/LearnerAuditorFitter.html">LearnerAuditorFitter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.glmnet"</span>, alpha <span class="op">=</span> <span class="fl">0</span>, lambda <span class="op">=</span> <span class="fl">2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">post</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lasso</span> <span class="op">=</span> <span class="va"><a href="../reference/LearnerAuditorFitter.html">LearnerAuditorFitter</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.glmnet"</span>, alpha <span class="op">=</span> <span class="fl">1</span>, lambda <span class="op">=</span> <span class="fl">40</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">post</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The ridge regression will only be given access to the initial predictor variables when post-processing the random forest predictions. In contrast, we allow the lasso regression to audit the initial predictions both with the initial predictors and the subpopulations (sex, hispanic ethnicity, race). In summary, we have:</p>
<ul>
<li>
<code>rf</code>: Initial random forest</li>
<li>
<code>rf_mc_ridge</code>: Random forest, post-processed with ridge regression and the initial set of predictor variables</li>
<li>
<code>rf_mc_lasso</code>: Random forest, post-processed with lasso regression and the extended set of predictors</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_mc_ridge</span> <span class="op">=</span> <span class="va"><a href="../reference/MCBoost.html">MCBoost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>init_predictor <span class="op">=</span> <span class="va">init_rf</span>,</span>
<span>                          auditor_fitter <span class="op">=</span> <span class="va">ridge</span>,</span>
<span>                          multiplicative <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          partition <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          max_iter <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">rf_mc_ridge</span><span class="op">$</span><span class="fu">multicalibrate</span><span class="op">(</span><span class="va">d1</span>, <span class="va">l</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_mc_lasso</span> <span class="op">=</span> <span class="va"><a href="../reference/MCBoost.html">MCBoost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>init_predictor <span class="op">=</span> <span class="va">init_rf</span>,</span>
<span>                          auditor_fitter <span class="op">=</span> <span class="va">lasso</span>,</span>
<span>                          multiplicative <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          partition <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          max_iter <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">rf_mc_lasso</span><span class="op">$</span><span class="fu">multicalibrate</span><span class="op">(</span><span class="va">d2</span>, <span class="va">l</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-evaluation-1">Model Evaluation<a class="anchor" aria-label="anchor" href="#model-evaluation-1"></a>
</h3>
<p>We again compute predicted probabilities and class predictions using the initial and post-processed models.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span><span class="op">$</span><span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rf</span>, <span class="va">test</span><span class="op">)</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">rf_mc_ridge</span> <span class="op">&lt;-</span> <span class="va">rf_mc_ridge</span><span class="op">$</span><span class="fu">predict_probs</span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">rf_mc_lasso</span> <span class="op">&lt;-</span> <span class="va">rf_mc_lasso</span><span class="op">$</span><span class="fu">predict_probs</span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">c_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">rf</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">c_rf_mc_ridge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">rf_mc_ridge</span><span class="op">)</span></span>
<span><span class="va">test</span><span class="op">$</span><span class="va">c_rf_mc_lasso</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">rf_mc_lasso</span><span class="op">)</span></span></code></pre></div>
<p>Here we compare the overall accuracy of the initial and post-processed models. As before, we observe small differences in overall performance.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">c_rf</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8142025</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">c_rf_mc_ridge</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8143904</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">c_rf_mc_lasso</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8132632</span></span></code></pre></div>
<p>However, we might be concerned with calibration in subpopulations. In the following we focus on subgroups defined by 2-way conjunctions of sex, hispanic ethnicity, and race.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">grouping_vars</span>, <span class="va">group_by_at</span>, .tbl <span class="op">=</span> <span class="va">test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">summarise</span>,</span>
<span>      <span class="st">'bias_rf'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,</span>
<span>      <span class="st">'bias_rf_mc_ridge'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rf_mc_ridge</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,</span>
<span>      <span class="st">'bias_rf_mc_lasso'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rf_mc_lasso</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,</span>
<span>      <span class="st">'size'</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This evaluation focuses on the difference between the average predicted risk of healthcare non-coverage and the observed proportion of non-coverage in the test data for subgroups. Considering the MCBoost-Ridge (<code>rf_mc_ridge</code>) and MCBoost-Lasso (<code>rf_mc_lasso</code>) results, post-processing with MCBoost reduces bias for many subpopulations.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eval</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">bias_rf</span><span class="op">:</span><span class="va">bias_rf_mc_lasso</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/formattable.html" class="external-link">formattable</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">eval</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/area.html" class="external-link">area</a></span><span class="op">(</span><span class="va">row</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://renkun-ken.github.io/formattable/reference/color_tile.html" class="external-link">color_tile</a></span><span class="op">(</span><span class="st">"lightgreen"</span>, <span class="st">"transparent"</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table table table-condensed">
<thead><tr>
<th style="text-align:right;">
size
</th>
<th style="text-align:right;">
bias_rf
</th>
<th style="text-align:right;">
bias_rf_mc_ridge
</th>
<th style="text-align:right;">
bias_rf_mc_lasso
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
4296
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.345</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ebfceb">3.593</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">3.855</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2772
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.445</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #cff7cf">1.637</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">2.518</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2551
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.484</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">3.782</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #defade">3.406</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2508
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.428</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c2f5c2">2.809</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">1.457</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2508
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.428</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c2f5c2">2.809</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">1.457</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2206
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">1.386</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #cff7cf">2.589</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">3.486</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
2090
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">3.358</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.653</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #dbf9db">4.244</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1867
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #bcf4bc">11.116</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">11.865</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">10.622</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1788
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #bff5bf">11.847</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">12.572</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">11.306</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1284
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">5.199</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #cef7ce">3.742</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">1.840</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
1224
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">3.620</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #b1f3b1">1.829</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">1.055</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
967
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">9.711</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">10.574</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c1f5c1">10.093</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
900
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ddf9dd">12.625</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">13.252</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">11.190</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
792
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.380</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #bff5bf">3.387</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.645</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
751
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.115</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c2f5c2">3.133</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.320</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
751
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.115</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c2f5c2">3.133</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.320</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
440
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">5.082</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #cbf7cb">4.074</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.929</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
416
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.695</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ccf7cc">3.697</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.499</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
352
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">3.503</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #a5f1a5">2.528</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.290</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
335
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">3.394</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #acf2ac">2.433</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">2.098</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
235
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">4.108</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">6.095</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c8f6c8">5.116</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">5.157</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">7.256</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #caf6ca">6.264</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
197
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">5.157</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">7.256</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #caf6ca">6.264</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
126
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">3.276</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">4.909</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #e8fbe8">4.579</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
109
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">5.070</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">7.465</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #aef2ae">5.736</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
105
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">4.500</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">6.233</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #eafbea">5.918</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
92
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">5.908</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">8.424</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #b1f3b1">6.660</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
41
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">9.241</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">8.037</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #c3f5c3">8.592</span>
</td>
</tr>
<tr>
<td style="text-align:right;">
38
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">1.330</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #90ee90">0.072</span>
</td>
<td style="text-align:right;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #d3f8d3">0.838</span>
</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Florian Pfisterer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
